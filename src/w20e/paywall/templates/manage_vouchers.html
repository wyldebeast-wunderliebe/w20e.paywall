{% extends "base.html" %}

{% block title %}Voucher manager{% endblock %}

{% block extra_js %}

    <script src="https://code.jquery.com/jquery-3.1.1.min.js"
            integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
            crossorigin="anonymous">
    </script>

    <script>
        $(document).ready(function() {
            $(".btn-verify").on("click", function(event) {
                event.preventDefault();
                $.ajax({
                    url: $(this).attr("href"),
                    context: $("tr[data-voucher="+ $(this).attr("data-voucher-code") +"]"),
                    success: function (data) {
                        if(data.redirect) {
                            window.location = data.redirect;
                        } else {
                            $(this).addClass("alert-success");
                            $(this).find("td:eq(2)").text(data.status);
                            $(this).find("td:eq(3)").text(data.expires);
                            $(this).find("td:eq(4)").text(data.count);
                        }
                    }
                });
            })
        });

    </script>

{% endblock %}

{% block content %}

    <nav class="navbar sticky-top navbar-toggleable-md navbar-light bg-faded">
        <a class="navbar-brand" href="#">Voucher manager</a>
        <small>
            <a href="new_voucher"
               class="btn btn-outline-success btn-sm"
               role="button">
                buy voucher
            </a>
            <a href="delete_voucher/all_expired"
               class="btn btn-outline-danger btn-sm"
               role="button">
                delete all expired vouchers
            </a>
            {% if current_cookie %}
            <a href="verify_voucher/{{ current_cookie }}"
               data-voucher-code="{{ current_cookie }}"
               class="btn btn-outline-info btn-sm btn-verify"
               role="button">check voucher in cookie: {{ current_cookie }}</a>
            {% endif %}
        </small>
    </nav>

    <div class="table-responsive">
        <table class="table">
            <tr>
                <th>voucher code</th>
                <th>payment id</th>
                <th>status</th>
                <th>expires</th>
                <th>visits left</th>
                <th>valid</th>
                <th></th>
            </tr>
            {% for voucher_code in vouchers.keys() %}
            {% if not voucher_code.startswith('_') %}
            <tr data-voucher={{ voucher_code }}>
                <td><a href="verify_voucher/{{ voucher_code }}"
                       data-voucher-code="{{ voucher_code }}"
                       class="btn btn-outline-info btn-sm btn-verify" role="button">{{
                    voucher_code }}</a></td>
                {% set voucher = vouchers.hgetall(voucher_code) %}
                {% for attr in voucher %}
                <td>{{ voucher[attr] in ['None', '0'] and '-' or voucher[attr] }}</td>
                {% endfor %}
                <td>{{ voucher | is_valid }}</td>
                <td>
                    <a href="delete_voucher/{{ voucher_code }}"
                       class="btn btn-outline-danger btn-sm" role="button">
                        <i class="fa fa-times" aria-hidden="true"></i>
                    </a>
                </td>
            </tr>
            {% endif %}
            {% endfor %}
        </table>
    </div>
{% endblock %}